<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>three.js webgl - viewer</title>
		<meta charset="utf-8">
		
		<style type="text/css">
		body {
			margin:0;
			overflow: hidden;
			background: #000;
		}

		#file_dialog {
			width:100%;
			height:100%;
			position:absolute;
			top:0px;
			left:0px;
			z-index:100;
		}

		#drop_zone {
			position:absolute;
			width:100%;
			height:100%;
			padding:20% 0;
			color: #eee;
			background:rgba(0, 0, 0, 0.25);
			text-shadow:#000 1px 1px 1px;
		}
		  
		#drop_label {
			text-align: center;
			font: 20pt bold georgia;
			font-variant:small-caps;
			text-transform:uppercase;
		}
		
		#help {
			margin:1em 0 0 0;
			text-align:center;
		}
		
		#file_list { 
			text-align: left;
		}
		
		#file_list ul { padding:0; margin:0 }
		#file_list ul li { list-style-type:none }
		
		#gui_wrapper {
			position:absolute;
			top:0px;
			right:0px;
			width:200px;
			height:100%;
			background:hsla(10,30%,80%, 0.75);
			padding:10px 20px;
			z-index:200;
		}
		
		.lbl { font-weight:bold }
		
		.chk { 
			background:hsla(10,80%,50%, 0.4); 
			color:#fff;
			width:14px; 
			height:14px; 
			display:inline-block;
			text-align:center;
			font-weight:bold;
			font-family:verdana;
			font-size:14px;
			line-height:10px;
			cursor:pointer;
		}
		
		.hud { display:block }
		
		#hud_button { 
			background:#000;
			color:#fff;
			width:20px;
			height:20px;
			text-align:center;
			font-weight:bold;
			position:absolute;
			top:0px;
			right:0px;
			z-index:250;
			cursor:pointer;
		}
		
		.header {
			color: hsl(10, 80%, 30%);
			font-weight:bold; 
			text-transform:uppercase;			
		}
		
		.overlay {
			position:absolute;
			left:0px;
			top:0px;
			width:100%; 
			height:100%; 
			background-size: 100%;
			z-index:50;
			display:none;
		}
		
		#overlayDirt { 
			background: url(textures/layers/VignetteWithDirt_alpha.png) no-repeat;
		}		

		#overlayVignette { 
			background: url(textures/layers/Vignette_alpha.png) no-repeat;
		}		

		#overlayLensFlare { 
			background: url(textures/layers/LensFlare_alpha.png) no-repeat;
		}		

		</style>
		
	</head>

	<body>
	
		<div id="viewport"></div> 

		<script type="text/javascript" src="js/Three.js"></script>

		<!--
		<script type="text/javascript" src="../build/Three.js"></script>
		
		<script type="text/javascript" src="../src/Three.js"></script>
		<script type="text/javascript" src="../src/core/Color.js"></script>
		<script type="text/javascript" src="../src/core/Vector2.js"></script>
		<script type="text/javascript" src="../src/core/Vector3.js"></script>
		<script type="text/javascript" src="../src/core/Vector4.js"></script>
		<script type="text/javascript" src="../src/core/Ray.js"></script>
		<script type="text/javascript" src="../src/core/Rectangle.js"></script>
		<script type="text/javascript" src="../src/core/Matrix3.js"></script>
		<script type="text/javascript" src="../src/core/Matrix4.js"></script>
		<script type="text/javascript" src="../src/core/Object3D.js"></script>
		<script type="text/javascript" src="../src/core/Quaternion.js"></script>
		<script type="text/javascript" src="../src/core/Vertex.js"></script>
		<script type="text/javascript" src="../src/core/Face3.js"></script>
		<script type="text/javascript" src="../src/core/Face4.js"></script>
		<script type="text/javascript" src="../src/core/UV.js"></script>
		<script type="text/javascript" src="../src/core/Geometry.js"></script>
		<script type="text/javascript" src="../src/core/Spline.js"></script>
		<script type="text/javascript" src="../src/animation/AnimationHandler.js"></script>
		<script type="text/javascript" src="../src/animation/Animation.js"></script>
		<script type="text/javascript" src="../src/cameras/Camera.js"></script>
		<script type="text/javascript" src="../src/cameras/QuakeCamera.js"></script>
		<script type="text/javascript" src="../src/lights/Light.js"></script>
		<script type="text/javascript" src="../src/lights/AmbientLight.js"></script>
		<script type="text/javascript" src="../src/lights/DirectionalLight.js"></script>
		<script type="text/javascript" src="../src/lights/PointLight.js"></script>
		<script type="text/javascript" src="../src/materials/Material.js"></script>
		<script type="text/javascript" src="../src/materials/Mappings.js"></script>
		<script type="text/javascript" src="../src/materials/LineBasicMaterial.js"></script>
		<script type="text/javascript" src="../src/materials/MeshBasicMaterial.js"></script>
		<script type="text/javascript" src="../src/materials/MeshLambertMaterial.js"></script>
		<script type="text/javascript" src="../src/materials/MeshPhongMaterial.js"></script>
		<script type="text/javascript" src="../src/materials/MeshDepthMaterial.js"></script>
		<script type="text/javascript" src="../src/materials/MeshNormalMaterial.js"></script>
		<script type="text/javascript" src="../src/materials/MeshFaceMaterial.js"></script>
		<script type="text/javascript" src="../src/materials/MeshShaderMaterial.js"></script>
		<script type="text/javascript" src="../src/materials/ParticleBasicMaterial.js"></script>
		<script type="text/javascript" src="../src/materials/ParticleCircleMaterial.js"></script>
		<script type="text/javascript" src="../src/materials/ParticleDOMMaterial.js"></script>
		<script type="text/javascript" src="../src/materials/Texture.js"></script>
		<script type="text/javascript" src="../src/materials/RenderTarget.js"></script>
		<script type="text/javascript" src="../src/materials/Uniforms.js"></script>
		<script type="text/javascript" src="../src/objects/Particle.js"></script>
		<script type="text/javascript" src="../src/objects/ParticleSystem.js"></script>
		<script type="text/javascript" src="../src/objects/Line.js"></script>
		<script type="text/javascript" src="../src/objects/Mesh.js"></script>
		<script type="text/javascript" src="../src/objects/Bone.js"></script>
		<script type="text/javascript" src="../src/objects/SkinnedMesh.js"></script>
		<script type="text/javascript" src="../src/objects/Ribbon.js"></script>
		<script type="text/javascript" src="../src/objects/Sound.js"></script>
		<script type="text/javascript" src="../src/objects/LOD.js"></script>
		<script type="text/javascript" src="../src/scenes/Scene.js"></script>
		<script type="text/javascript" src="../src/scenes/Fog.js"></script>
		<script type="text/javascript" src="../src/scenes/FogExp2.js"></script>
		<script type="text/javascript" src="../src/renderers/Projector.js"></script>
		<script type="text/javascript" src="../src/renderers/DOMRenderer.js"></script>
		<script type="text/javascript" src="../src/renderers/CanvasRenderer.js"></script>
		<script type="text/javascript" src="../src/renderers/SVGRenderer.js"></script>
		<script type="text/javascript" src="../src/renderers/WebGLRenderer.js"></script>
		<script type="text/javascript" src="../src/renderers/SoundRenderer.js"></script>
		<script type="text/javascript" src="../src/renderers/renderables/RenderableObject.js"></script>
		<script type="text/javascript" src="../src/renderers/renderables/RenderableFace3.js"></script>
		<script type="text/javascript" src="../src/renderers/renderables/RenderableParticle.js"></script>
		<script type="text/javascript" src="../src/renderers/renderables/RenderableLine.js"></script>
		<script type="text/javascript" src="../src/extras/GeometryUtils.js"></script>
		<script type="text/javascript" src="../src/extras/ImageUtils.js"></script>
		<script type="text/javascript" src="../src/extras/SceneUtils.js"></script>
		<script type="text/javascript" src="../src/extras/ShaderUtils.js"></script>
		<script type="text/javascript" src="../src/extras/primitives/Cube.js"></script>
		<script type="text/javascript" src="../src/extras/primitives/Cylinder.js"></script>
		<script type="text/javascript" src="../src/extras/primitives/Plane.js"></script>
		<script type="text/javascript" src="../src/extras/primitives/Sphere.js"></script>
		<script type="text/javascript" src="../src/extras/primitives/Torus.js"></script>
		<script type="text/javascript" src="../src/extras/primitives/Icosahedron.js"></script>
		<script type="text/javascript" src="../src/extras/primitives/LathedObject.js"></script>
		<script type="text/javascript" src="../src/extras/objects/MarchingCubes.js"></script>
		<script type="text/javascript" src="../src/extras/io/Loader.js"></script>
		-->
		
		<script type="text/javascript" src="js/Detector.js"></script>
		<script type="text/javascript" src="js/RequestAnimationFrame.js"></script>
		<script type="text/javascript" src="js/Stats.js"></script>	

		<div class="overlay" id="overlayDirt"></div>	
		<div class="overlay" id="overlayVignette"></div>
		<div class="overlay" id="overlayLensFlare"></div>
		
		<div class="hud" id="file_dialog"> 
			<div id="drop_zone">
				<div id="drop_label">Drop files here</div>
				<div id="help">
				Press SPACE to toggle user interface
				</div>
			</div> 
		</div>
		
		<div class="hud" id="gui_wrapper">
			<span class="header">Background</span><br/>
			<span id="b_fog" class="chk">&nbsp;</span> <span id="l_fog" class="lbl">Fog</span> <br/>
			<br/>
			<span id="b_bgDark" class="chk">&nbsp;</span> <span id="l_bgDark" class="lbl">Dark</span> <br/>
			<span id="b_bgLight" class="chk">&nbsp;</span> <span id="l_bgLight" class="lbl">Light</span> <br/>
			<br/>
			
			<span class="header">Postprocessing</span><br/>
			<span id="b_noise" class="chk">&nbsp;</span> <span id="l_noise" class="lbl">Noise</span> <br/>
			<span id="b_bloom" class="chk">&nbsp;</span> <span id="l_bloom" class="lbl">Bloom</span> <br/>
			<span id="b_none" class="chk">&nbsp;</span> <span id="l_none" class="lbl">None</span> <br/>
			<br/>
			
			<span class="header">Overlays</span><br/>
			<span id="b_film" class="chk">&nbsp;</span> <span id="l_film" class="lbl">Film strips</span> <br/>
			<span id="b_vignette" class="chk">&nbsp;</span> <span id="l_vignette" class="lbl">Vignette</span> <br/>
			<span id="b_dirt" class="chk">&nbsp;</span> <span id="l_dirt" class="lbl">Dirt</span> <br/>
			<span id="b_lensFlare" class="chk">&nbsp;</span> <span id="l_lensFlare" class="lbl">Lens flare</span> <br/>
			<br/>
			
			<span class="header">Scale</span><br/>
			
			<span id="b_s001" class="chk">&nbsp;</span> <span id="l_s001" class="lbl">0.01</span> <br/>
			<span id="b_s01" class="chk">&nbsp;</span> <span id="l_s01" class="lbl">0.1</span> <br/>
			<span id="b_s05" class="chk">&nbsp;</span> <span id="l_s05" class="lbl">0.5</span> <br/>
			<span id="b_s1" class="chk">&diams;</span> <span id="l_s1" class="lbl">1</span> <br/>
			<span id="b_s2" class="chk">&diams;</span> <span id="l_s2" class="lbl">2</span> <br/>
			<span id="b_s10" class="chk">&nbsp;</span> <span id="l_s10" class="lbl">10</span> <br/>
			<span id="b_s100" class="chk">&nbsp;</span> <span id="l_s100" class="lbl">100</span> <br/>
			<br/>
			
			<span class="header">Files</span><br/>
			<div id="file_list"></div> 

		</div>
		
		<div id="hud_button">+</div>

		<script type="text/javascript">
	
		if ( ! Detector.webgl ) Detector.addGetWebGLMessage();
	
		if ( ! Detector.fileapi ) alert( 'The File APIs are not fully supported in this browser.' );

	
		function $( id ) { return document.getElementById( id ); }
		function rr( a, b ) { return a + ( b - a ) * Math.random(); }
		
		var DragAndDrop = {};
		
		var SCREEN_WIDTH = window.innerWidth;
		var SCREEN_HEIGHT = window.innerHeight;
		
		var GLOBAL_SCALE = 1, 
			BASE_SCALE = 1,
			SCALES = [ [ "b_s001", 0.01 ], [ "b_s01", 0.1 ], [ "b_s05", 0.5 ], [ "b_s1", 1 ], [ "b_s2", 2 ], [ "b_s10", 10 ], [ "b_s100", 100 ] ];

		var overlays = {
			filmStrip: 	false,
			dirt:		false,
			vignette: 	false,
			lensFlare:	false
		};
		
		var viewport, stats;

		var camera, scene, sceneTemp, renderer;
		
		var fogdensity;

		var postprocessing = { enabled : false };
		
		init();
		animate();
		
		function init() {

			viewport = $( "viewport" );
			
			fogdensity = 0.000125;
			
			scene = new THREE.Scene();
			scene.fog = new THREE.FogExp2( 0x000000, fogdensity );
			
			renderer = new THREE.WebGLRenderer();
			renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );

			renderer.autoClear = false;
			renderer.sortObjects = false;
			renderer.setClearColor( scene.fog.color, 1 );

			renderer.domElement.style.position = "absolute";
			renderer.domElement.style.top = "0px";
			renderer.domElement.style.left = "0px";
	
			viewport.appendChild( renderer.domElement );
			
			//camera = new THREE.Camera( 30, window.innerWidth / window.innerHeight, 1, 100000 );
			
			
			camera = new THREE.QuakeCamera( { fov: 60, aspect: SCREEN_WIDTH / SCREEN_HEIGHT, near: 1, far: 100000,
											  movementSpeed: 3, lookSpeed: 0.0025, noFly: false, lookVertical: true
											  } );

			camera.position.z = 500;
			

			
			// LIGHTS

			var ambient = new THREE.AmbientLight( 0x221100 );
			scene.addLight( ambient );

			var directionalLight = new THREE.DirectionalLight( 0xffeedd );
			directionalLight.position.set( 1, 1, 1 );
			directionalLight.position.normalize();
			scene.addLight( directionalLight );

			initPostprocessingBloom( postprocessing );
			//initPostprocessingNoise( postprocessing );
			
			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			stats.domElement.style.left = '0px';
			stats.domElement.style.zIndex = 500;
			viewport.appendChild( stats.domElement );
			
			iniGui();
			createTempScene( scene );
			
			window.addEventListener( 'resize', onWindowResize, false );
			window.addEventListener( 'keydown', onKeyDown, false );

		};

		function onKeyDown ( event ) {
			
			switch( event.keyCode ) {

				/*space*/
				case 32: toggleHUD( event ); break;

			}

		};

		function onWindowResize( event ) {
 
			updateViewport();
 
		};
			
		function createTempScene( parent ) {
		
			var i, x, y, z, 
				d = 10000,
				s = BASE_SCALE,
				mesh,
				geo = new Cube( 400, 400, 400 ),
				mat = new THREE.MeshLambertMaterial();
				
			for ( i = 0; i < 1000; i++ ) {
				
				mesh = new THREE.Mesh( geo, mat );
				
				x = rr( -d, d );
				y = rr( -d, d );
				z = rr( -d, d );
				
				mesh.position.set( x, y, z );

				x = rr( -3, 3 );
				y = rr( -3, 3 );
				z = rr( -3, 3 );
				
				mesh.rotation.set( x, y, z );
				
				mesh.scale.set( s, s, s );

				//mesh.matrixAutoUpdate = false;
				mesh.updateMatrix();
				
				parent.addObject( mesh );
				
			}
			
		};
		
		
		// DOM helpers
		
		function toggle( id, how ) {
			
			var elStyle = $( id ).style;
			
			if ( elStyle.display == "none" )
				elStyle.display = how !==undefined ? how : "block";
			else
				elStyle.display = "none";
			
		};
		
		function show( id ) {
		
			$( id ).style.display = "block";
			
		};

		function hide( id ) {
		
			$( id ).style.display = "none";
			
		};

		// Utils
		
		function capitalize( s ) {
		
			return s[ 0 ].toUpperCase() + s.substring( 1, s.length );

		};

		// GUI
		
		function toggleHUD( e ) {
			
			e.stopPropagation();
			e.preventDefault();
			
			toggle( "file_dialog" );
			toggle( "gui_wrapper" );
			
		};
		
		function toggleFog() {
		
			if ( scene.fog.density == 0 ) {
			
				scene.fog.density = fogdensity;
				
			} else {
			
				scene.fog.density = 0;
				
			}
			
			refreshGUI();
			
		};

		function setPostNoise() {
		
			initPostprocessingNoise( postprocessing );
			postprocessing.enabled = true;
			
			refreshGUI();

		};

		function setPostBloom() {
		
			initPostprocessingBloom( postprocessing );
			postprocessing.enabled = true;
			
			refreshGUI();

		};

		function setPostNone() {
		
			postprocessing.enabled = false;
			
			refreshGUI();

		};

		function updateAspect() {
		
			camera.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
			camera.updateProjectionMatrix();

			renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );

		};
		
		function updateViewport() {
		
			if ( overlays.filmStrip ) {

				SCREEN_WIDTH = window.innerWidth;
				SCREEN_HEIGHT = window.innerHeight - 200;

				updateAspect();
				renderer.domElement.style.top = "100px";
				

			} else {

				SCREEN_WIDTH = window.innerWidth;
				SCREEN_HEIGHT = window.innerHeight;

				updateAspect();
				renderer.domElement.style.top = "0px";

			}
			
			if ( postprocessing.type == "bloom" )
				initPostprocessingBloom( postprocessing );
			else
				initPostprocessingNoise( postprocessing );

		};
		
		function toggleFilm() {
		
			overlays.filmStrip = !overlays.filmStrip;
			
			updateViewport();
			refreshGUI();

		};

		function setBackground( hex ) {
		
			scene.fog.color.setHex( hex );
			renderer.setClearColor( scene.fog.color );
			
			refreshGUI();
		
		};		

		function toggleOverlay( label ) {
		
			overlays[ label ] = !overlays[ label ];
			
			var id = "overlay" + capitalize( label );
			
			if ( overlays[ label ] )
				show( id );
			else
				hide( id );
			
			refreshGUI();
			
		};

		function refreshGUI() {
			
			// checkboxes
			
			$( "b_fog" ).innerHTML = scene.fog.density != 0 ? "x" : "&nbsp;";			
			
			$( "b_film" ).innerHTML = overlays.filmStrip ? "x" : "&nbsp;";
			$( "b_dirt" ).innerHTML = overlays.dirt ? "x" : "&nbsp;";
			$( "b_vignette" ).innerHTML = overlays.vignette ? "x" : "&nbsp;";
			$( "b_lensFlare" ).innerHTML = overlays.lensFlare ? "x" : "&nbsp;";
			
			// selections
			
			var c = scene.fog.color.hex;
			
			$( "b_bgLight" ).innerHTML = ( c == 0xffffff ) ? "&diams;" : "&nbsp;";
			$( "b_bgDark" ).innerHTML = ( c == 0x000000 ) ? "&diams;" : "&nbsp;";
			
			
			$( "b_noise" ).innerHTML = ( postprocessing.enabled && postprocessing.type == "noise" ) ? "&diams;" : "&nbsp;";
			$( "b_bloom" ).innerHTML = ( postprocessing.enabled && postprocessing.type == "bloom" ) ? "&diams;" : "&nbsp;";
			$( "b_none" ).innerHTML = ( ! postprocessing.enabled ) ? "&diams;" : "&nbsp;";
			
			var i, s;
			
			for ( i = 0; i < SCALES.length; i++ ) {
			
				s = SCALES[ i ];
				
				if( GLOBAL_SCALE == s[1] ) {
				
					$( s[0] ).innerHTML = "&diams;"
					
				} else {
				
					$( s[0] ).innerHTML = "&nbsp;";
				}
			}
			
			magicRepaint();

		};
		
		function magicRepaint() {
		
			// workaround Chrome compositing bug
			
			$( "gui_wrapper" ).style.display = "none";
			$( "gui_wrapper" ).offsetHeight;
			$( "gui_wrapper" ).style.display = "block";
			
		};
		
		function handleScale( values ) {
			
			function generateHandler( s ) {

				return function() {
						
						GLOBAL_SCALE = s;
						
						rescaleScene( BASE_SCALE * s );
						refreshGUI();
						
					}

			};
			
			var i, id, s;
			
			for ( i = 0; i < values.length; i++ ) {
				
				id = values[ i ][ 0 ];
				s  = values[ i ][ 1 ];
				
				$( id ).addEventListener( "click", generateHandler( s ), false );
				
			}
			
		};

		function handleProperty( ids, handler ) {
			
			for ( var i = 0; i < ids.length; i++ )
				$( ids[ i ] ).addEventListener( "click", handler, false );
			
		};

		function iniGui() {
		
			$( "hud_button" ).addEventListener( "click", toggleHUD, false );
			
			handleProperty( [ "b_fog", "l_fog" ], toggleFog );
			
			handleProperty( [ "b_noise", "l_noise" ], setPostNoise );
			handleProperty( [ "b_bloom", "l_bloom" ], setPostBloom );
			handleProperty( [ "b_none", "l_none" ], setPostNone );

			handleProperty( [ "b_film", "l_film" ], toggleFilm );

			handleProperty( [ "b_dirt", "l_dirt" ], function() { toggleOverlay( "dirt") } );
			handleProperty( [ "b_vignette", "l_vignette" ], function() { toggleOverlay( "vignette") } );
			handleProperty( [ "b_lensFlare", "l_lensFlare" ], function() { toggleOverlay( "lensFlare") } );
			
			handleScale( SCALES );
			
			handleProperty( [ "b_bgDark", "l_bgDark" ], function() { setBackground( 0x000000 ) } );
			handleProperty( [ "b_bgLight", "l_bgLight" ], function() { setBackground( 0xffffff ) } );
			
			refreshGUI();
		
		};
		
		DragAndDrop.onDragOver = function( evt ) {
		
			evt.stopPropagation();
			evt.preventDefault();

		};
		 
		DragAndDrop.onDragFileDrop = function( evt ) {
		
			evt.stopPropagation();
			evt.preventDefault();
		 
			var i, f, 
				files = evt.dataTransfer.files,
				output = [],
				loader = new THREE.Loader(),
				callbackObject = function( geometry ) { addObject( geometry, 0, 0, 0, 1 ) };

			for ( i = 0; f = files[i]; i++ ) {
			
				output.push('<li><strong>', f.name, '</strong> (', f.type || 'n/a', ') - ',
						f.size, ' bytes, last modified: ',
						f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
						'</li>');

				var reader = new FileReader();

				// Closure to capture the file information
				
				reader.onload = ( function( theFile ) {
					
					return function( e ) {
					
						var content = e.target.result,
							bb, blobURL = new BlobBuilder();

						bb = new BlobBuilder();
						bb.append( content );

						if ( window.webkitURL )
							blobURL = window.webkitURL.createObjectURL( bb.getBlob() );
						else
							blobURL = window.URL.createObjectURL( bb.getBlob() );

						loader.loadAscii( { model: blobURL, callback: callbackObject } );					

					};

				  })(f);

				reader.readAsText( f );

			}
			
			$('file_list').innerHTML = '<ul>' + output.join('') + '</ul>';

		};
		 
		function resetScene() {
			
			var i, l = scene.objects.length;
			
			for( i = l - 1; i >= 0; i-- ) {
				
				scene.removeObject( scene.objects[ i ] );

			}
			
		};

		function rescaleScene( s ) {
			
			console.log(s);
			
			var i, o, l = scene.objects.length;
			
			for( i = 0; i < l; i++ ) {
				
				o = scene.objects[ i ];
				
				o.scale.set( s, s, s );
				o.updateMatrix();

			}
			
		};

		function addObject( geometry, x, y, z, s ) {

			resetScene();
			
			var material = new THREE.MeshFaceMaterial(),
				mesh = new THREE.Mesh( geometry, material );
				
			console.log( geometry );
			
			mesh.position.set( x, y, z );
			mesh.scale.set( s, s, s );
			//mesh.matrixAutoUpdate = false;
			mesh.updateMatrix();
			scene.addObject( mesh );

		};
		 

		function initPostprocessingNoise( effect ) {
			
			effect.type = "noise";
			
			effect.scene = new THREE.Scene();		
			
			effect.camera = new THREE.Camera();
			effect.camera.projectionMatrix = THREE.Matrix4.makeOrtho( SCREEN_WIDTH / - 2, SCREEN_WIDTH / 2, SCREEN_HEIGHT / 2, SCREEN_HEIGHT / - 2, -10000, 10000 );
			effect.camera.position.z = 100;
			
			effect.texture = new THREE.RenderTarget( SCREEN_WIDTH, SCREEN_HEIGHT, { minFilter: THREE.LinearFilter, magFilter: THREE.NearestFilter } );

			var film_shader = ShaderUtils.lib["film"];
			var film_uniforms = Uniforms.clone( film_shader.uniforms );
			
			film_uniforms["tDiffuse"].texture = effect.texture;
			
			effect.material = new THREE.MeshShaderMaterial( { uniforms: film_uniforms, vertexShader: film_shader.vertexShader, fragmentShader: film_shader.fragmentShader } );
			effect.material.uniforms.grayscale.value = 0;
			
			var quad = new THREE.Mesh( new Plane( SCREEN_WIDTH, SCREEN_HEIGHT ), effect.material );
			quad.position.z = -500;
			effect.scene.addObject( quad );

		}
		
		function initPostprocessingBloom( effect ) {

			effect.type = "bloom";
			
			effect.scene = new THREE.Scene();

			effect.camera = new THREE.Camera();
			effect.camera.projectionMatrix = THREE.Matrix4.makeOrtho( SCREEN_WIDTH / - 2, SCREEN_WIDTH / 2, SCREEN_HEIGHT / 2, SCREEN_HEIGHT / - 2, -10000, 10000 );
			effect.camera.position.z = 100;

			var pars = { minFilter: THREE.LinearFilter, magFilter: THREE.LinearFilter };
			effect.rtTexture1 = new THREE.RenderTarget( SCREEN_WIDTH, SCREEN_HEIGHT, pars );
			effect.rtTexture2 = new THREE.RenderTarget( 512, 512, pars );
			effect.rtTexture3 = new THREE.RenderTarget( 512, 512, pars );

			var screen_shader = ShaderUtils.lib["screen"];
			var screen_uniforms = Uniforms.clone( screen_shader.uniforms );

			screen_uniforms["tDiffuse"].texture = effect.rtTexture1;
			screen_uniforms["opacity"].value = 1.0;

			effect.materialScreen = new THREE.MeshShaderMaterial( {

				uniforms: screen_uniforms,
				vertexShader: screen_shader.vertexShader,
				fragmentShader: screen_shader.fragmentShader,
				blending: THREE.AdditiveBlending

			} );

			var convolution_shader = ShaderUtils.lib["convolution"];
			var convolution_uniforms = Uniforms.clone( convolution_shader.uniforms );

			effect.blurx = new THREE.Vector2( 0.001953125, 0.0 ),
			effect.blury = new THREE.Vector2( 0.0, 0.001953125 );

			convolution_uniforms["tDiffuse"].texture = effect.rtTexture1;
			convolution_uniforms["uImageIncrement"].value = effect.blurx;
			convolution_uniforms["cKernel"].value = ShaderUtils.buildKernel( 4.0 );

			effect.materialConvolution = new THREE.MeshShaderMaterial( {

				uniforms: convolution_uniforms,
				vertexShader:   "#define KERNEL_SIZE 25.0\n" + convolution_shader.vertexShader,
				fragmentShader: "#define KERNEL_SIZE 25\n"   + convolution_shader.fragmentShader

			} );

			effect.quad = new THREE.Mesh( new Plane( SCREEN_WIDTH, SCREEN_HEIGHT ), effect.materialConvolution );
			effect.quad.position.z = -500;
			effect.scene.addObject( effect.quad );

		}
		
		
		function animate() {

			requestAnimationFrame( animate );

			render();
			stats.update();

		}

		function render() {
			
			renderer.clear();
			
			if ( postprocessing.enabled ) {
			
				if ( postprocessing.type == "noise" ) {
				
					postprocessing.material.uniforms.time.value += 0.01;
					
					renderer.render( scene, camera, postprocessing.texture, true );
					renderer.render( postprocessing.scene, postprocessing.camera );
					
				} else if ( postprocessing.type == "bloom" ) {

					// Render scene into texture

					renderer.render( scene, camera, postprocessing.rtTexture1, true );

					// Render quad with blured scene into texture (convolution pass 1)

					postprocessing.quad.materials = [ postprocessing.materialConvolution ];

					postprocessing.materialConvolution.uniforms.tDiffuse.texture = postprocessing.rtTexture1;
					postprocessing.materialConvolution.uniforms.uImageIncrement.value = postprocessing.blurx;

					renderer.render( postprocessing.scene, postprocessing.camera, postprocessing.rtTexture2, true );

					// Render quad with blured scene into texture (convolution pass 2)

					postprocessing.materialConvolution.uniforms.tDiffuse.texture = postprocessing.rtTexture2;
					postprocessing.materialConvolution.uniforms.uImageIncrement.value = postprocessing.blury;

					renderer.render( postprocessing.scene, postprocessing.camera, postprocessing.rtTexture3, true );

					// Render original scene with superimposed blur to texture

					postprocessing.quad.materials = [ postprocessing.materialScreen ];

					postprocessing.materialScreen.uniforms.tDiffuse.texture = postprocessing.rtTexture3;
					postprocessing.materialScreen.uniforms.opacity.value = 1.0;

					renderer.render( postprocessing.scene, postprocessing.camera, postprocessing.rtTexture1, false );

					// Render to screen

					postprocessing.materialScreen.uniforms.tDiffuse.texture = postprocessing.rtTexture1;
					renderer.render( postprocessing.scene, postprocessing.camera );
				
				}
				
			} else {
				
				renderer.render( scene, camera );
				
			}
			

		}
		

		// setup drag-and-drop listeners
		
		$( 'drop_zone' ).addEventListener( 'dragover', DragAndDrop.onDragOver, false );
		$( 'drop_zone' ).addEventListener( 'drop', DragAndDrop.onDragFileDrop, false );

		</script>

	</body>
</html>
