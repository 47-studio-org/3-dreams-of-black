<!DOCTYPE HTML>


<head>

  <title>three.js webgl - flamingo</title>
  <script type="text/javascript" src="gui-dat/gui.js"></script>
  <script type="text/javascript" src="gui-dat/controllers/slider.js"></script>
  <script type="text/javascript" src="gui-dat/controllers/controller.js"></script>
  <script type="text/javascript" src="gui-dat/controllers/controller.boolean.js"></script>
  <script type="text/javascript" src="gui-dat/controllers/controller.function.js"></script>
  <script type="text/javascript" src="gui-dat/controllers/controller.number.js"></script>
  <script type="text/javascript" src="gui-dat/controllers/controller.string.js"></script>
  <script type="text/javascript" src="js/Three.js"></script>
  <script type="text/javascript" src="js/Animal.js"></script>
  <script type="text/javascript" src="js/TriggerBig.js"></script>
  <script type="text/javascript" src="js/Detector.js"></script>
  <script type="text/javascript" src="js/RequestAnimationFrame.js"></script>
  <style type="text/css">
    @import url("style.css");
    @import url("gui-dat/gui.css");
  </style>
</head>

<body>
<div id="wrapper">
    <div id="canvasHolder"></div>
    <div id="viewerConsole">
      <div id="viewerModels">
      </div>
      <div id="viewerSettings">
      </div>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
</div>
<script>

if (! Detector.webgl) Detector.addGetWebGLMessage();

var params, gui;

var delta, time, oldTime = new Date().getTime();

var container, loader;

var camera, effector, scene, renderer;
var cameraDistance = 300;
var cameraTarget = new THREE.Vector3(0, 0, 0);

var light = [];

var rootY, rootZ, plane, wireMat, faceMat, mesh, sineTime;
var models = [];
var width = 960;
var height = 360;

var drag = false;
var mouseX = 0;
var mouseY = 0;
var offsetX = 0.5;
var offsetY = 0;
var zoom = 0;
var orbitY = 0.5;
var orbitZ = 0;
var riseY = 0;
var centerY = 0;
var gridSpeed = 1;

init();

function init() {
  container = document.createElement('div');
  container.id = "viewerCanvas";
  
  document.addEventListener('mouseup', mouseUp, false);
  document.addEventListener('mousemove', mouseMove, false);
  document.addEventListener('mousewheel', mouseWheel, false);
  document.getElementById('canvasHolder').appendChild(container);
  document.getElementById('canvasHolder').addEventListener('mousedown', mouseDown, false);
  document.getElementById('canvasHolder').addEventListener('mouseout', mouseOut, false);

  params = {"speed": 0.3, "morph": 1, "texture": true, "wireframe": false, "auto": true};
  gui = new GUI({domElement:  document.getElementById('viewerSettings')});
  gui.add(params, "speed", 0, 1).listen();
  gui.add(params, "morph", 0, 1).listen().onChange(function(){ params.auto = false; });
  gui.add(params, 'wireframe').listen();
  gui.add(params, 'texture', true).listen();


  camera = new THREE.Camera(45, width / height, 10, 8000);

  camera.position = new THREE.Vector3(-cameraDistance, 0, 0);
  camera.target.position = cameraTarget;

  renderer = new THREE.WebGLRenderer({ antialias: true, clearColor: 0x000000, clearAlpha: 0 });
  renderer.setSize(width, height);
  container.appendChild(renderer.domElement);


  light[0] = new THREE.AmbientLight( 0xffffff );
  light[0].color.setHSV( 0.6352941176470588,  0.36470588235294116, 0.25882352941176473 );

  light[1] = new THREE.DirectionalLight( 0xffffff );
  light[1].position.set( 0.3653150890069558,  0.7392613273917799, -0.5657186363969139 );
  light[1].color.setHSV( 0.07647058823529412, 0.058823529411764705,  0.7235294117647059 );
  light[1].castShadow = true;

  light[2] = new THREE.DirectionalLight( 0xffffff );
  light[2].position.set( -0.8304706750947658,  -0.47758995481714017,  0.2867512735201115 );
  light[2].color.setHSV( 0,  0, 0.5058823529411764 );
  light[2].castShadow = false;

  //gound plane
  wireMat = new THREE.MeshBasicMaterial({blending: THREE.BillboardBlending, color:0xb65024, opacity:0.1, wireframe: true });
  faceMat = new THREE.MeshLambertMaterial({blending: THREE.BillboardBlending, wireframe: true });

  plane = new THREE.Mesh(new THREE.Plane(1000, 1000, 10, 10), wireMat);
  plane.rotation.x = -Math.PI / 2;

  //Triggers
  models.push({"file": './files/models/city_triggers/City.TriggerMesh_Bus_.js', "base": './files/models/city_triggers/City.Bus_.js', "type": 'trigger', "centerY": 160, "effector": [0,0,2500,0,0,1000]});
  models.push({"file": './files/models/city_triggers/City.TriggerMesh_Car_.js', "base": './files/models/city_triggers/City.Car_.js', "type": 'trigger', "centerY": 160, "effector": [0,0,2800,0,0,1000]});
  models.push({"file": './files/models/city_triggers/City.TriggerMesh_CarPile_.js', "base": './files/models/city_triggers/City.CarPile_.js', "type": 'trigger', "centerY": 160, "effector": [0,0,2800,0,0,1000]});
  models.push({"file": './files/models/city_triggers/City.TriggerMesh_CarNiss_.js', "base": './files/models/city_triggers/City.CarNiss_.js', "type": 'trigger', "centerY": 160, "effector": [0,0,2800,0,0,1000]});
  models.push({"file": './files/models/city_triggers/City.TriggerMesh_Console_10_.js', "base": './files/models/city_triggers/City.Console_10_.js', "type": 'trigger', "centerY": 1000, "effector": [-1500,1000,-4500,-1500,1000,4500]});
  models.push({"file": './files/models/city_triggers/City.TriggerMesh_LampPost_.js', "base": './files/models/city_triggers/City.LampPost_.js', "type": 'trigger', "centerY": 610, "effector": [0,-2200,0,0,1000,0]});
  models.push({"file": './files/models/city_triggers/City.TriggerMesh_SignMany_.js', "base": './files/models/city_triggers/City.SignMany_.js', "type": 'trigger', "centerY": 260, "effector": [0,-2500,0,0,-500,0]});
  
  //MORPHS
  models.push({"file": './files/models/animals_morphing/raven_eagle.js', "type": 'animal', "centerY": 0, "riseY" : 70, "speed": 0.9});
  models.push({"file": './files/models/animals_morphing/vulture_hummingbird.js', "type": 'animal', "centerY": 0, "riseY" : 70, "speed": 0.9});
  models.push({"file": './files/models/animals_morphing/owl_parrot.js', "type": 'animal', "centerY": 0, "riseY" : 70, "speed": 0.8});
  models.push({"file": './files/models/animals_morphing/stork_flamingo.js', "type": 'animal', "centerY": 0, "riseY" : 60, "speed": 0.8});
  models.push({"file": './files/models/animals_morphing/black_widow_scorpion.js', "type": 'animal', "centerY": 30, "riseY" : 0, "speed": 0.47});
  models.push({"file": './files/models/animals_morphing/wolf_fox.js', "type": 'animal', "centerY": 30, "riseY" : 0, "speed": 0.47});
  models.push({"file": './files/models/animals_morphing/fish1_fish2.js', "type": 'animal', "centerY": 100, "riseY" : -160, "speed": 0.2});
  models.push({"file": './files/models/animals_morphing/toad_treeFrog.js', "type": 'animal', "centerY": 30, "riseY" : 0, "speed": 0.47});
  models.push({"file": './files/models/animals_morphing/chowchow_retreiver.js', "type": 'animal', "centerY": 50, "riseY" : 0, "speed": 0.35});
  models.push({"file": './files/models/animals_morphing/sealRun_bearBrown.js', "type": 'animal', "centerY": 60, "riseY" : 0, "speed": 0.35});
  models.push({"file": './files/models/animals_morphing/horse_bear.js', "type": 'animal', "centerY": 90, "riseY" : 0, "speed": 0.47});
  models.push({"file": './files/models/animals_morphing/tarbuffaloA_tarbuffaloB.js', "type": 'animal', "centerY": 90, "riseY" : 0, "speed": 0.47});
  //BLACK SOUP
  models.push({"file": './files/models/animals/gator.js', "type": 'animal', "centerY": 40, "riseY" : 0, "speed": 0.4});
  models.push({"file": './files/models/animals/centipede.js', "type": 'animal', "centerY": 20, "riseY" : 0, "speed": 0.5});
  models.push({"file": './files/models/animals/goat.js', "type": 'animal', "centerY": 50, "riseY" : 0, "speed": 0.5});
  models.push({"file": './files/models/animals/crab.js', "type": 'animal', "centerY": 40, "riseY" : 0, "speed": 0.2});
  models.push({"file": './files/models/animals/cow.js', "type": 'animal', "centerY": 80, "riseY" : 0, "speed": 0});
  //LIFE SOUP
  models.push({"file": './files/models/animals/eagle.js', "type": 'animal', "centerY": 0, "riseY" : 80, "speed": 0.8});
  models.push({"file": './files/models/animals/elk.js', "type": 'animal', "centerY": 70, "riseY" : 0, "speed": 0.4});
  models.push({"file": './files/models/animals/moose.js', "type": 'animal', "centerY": 140, "riseY" : 0, "speed": 0.8});

  modelLoader(0);

}

function modelLoader(id) {
    loader = new THREE.JSONLoader();
    loader.load({ model: models[id].file, callback: function(g) {
    addModel(g, id);
  } });
}

function addModel(geometry, id) {
  models[id].geometry = geometry;

  link = document.createElement('a');
  link.setAttribute('class', 'modelLink');
  link.setAttribute('href', 'javascript:switchModel('+id+')');

  models[id].name = models[id].file.replace(/\\/g,'/').replace( /.*\//, '' );
  models[id].name = models[id].name.replace(".js", "");
  link.innerHTML = models[id].name.replace("_", "<br />");

  document.getElementById('viewerModels').appendChild(link);

  if (id == 0){
    switchModel(0);
    animate();
  }
  if (id < models.length-1) {
    modelLoader(id+1);
  }
}

var morphObject;

function switchModel(id) {

  scene = new THREE.Scene();
  rootY = new THREE.Object3D();
  rootZ = new THREE.Object3D();
  scene.addObject(rootZ);
  rootZ.addChild(rootY);

  scene.addLight( light[0] );
  scene.addLight( light[1] );
  scene.addLight( light[2] );

  rootY.addChild(plane);

  if (models[id].type == "trigger"){

    trigger = new TriggerBig( models[id].geometry, undefined );

    var baseLoader = new THREE.JSONLoader();
    baseLoader.load( { model: models[id].base, callback: function( geometry ) {
      var mesh = new THREE.Mesh( geometry, faceMat);
      //if (models[id].file.search("city") != -1) mesh.scale.set(0.1,0.1,0.1);
      //if (models[id].file.search("country") != -1) mesh.scale.set(10,10,10);
      mesh.rotation.x = -90 * Math.PI / 180;
      mesh.addChild( trigger.mesh );
      trigger.mesh.rotation.x = 90 * Math.PI / 180;
      trigger.mesh.scale.set( 1, 1, 1 );

      rootY.addChild( mesh );

      effector = new THREE.Mesh( new THREE.Sphere( 1500, 8, 8 ), wireMat);
      effector.start = new THREE.Vector3(models[id].effector[0],models[id].effector[1],models[id].effector[2]);
      effector.end = new THREE.Vector3(models[id].effector[3],models[id].effector[4],models[id].effector[5]);
      document.getElementById('guidat-morph').style.display = 'block';
//      rootY.addChild( effector );
    }});
    models[id].speed = models[id].riseY = 0;
    cameraDistance = 600 + trigger.mesh.boundRadius;
  }

  if (models[id].type == "animal"){
    morphObject = new ROME.Animal(models[id].geometry, true);
    morphObject.mesh.updateMatrix();
    morphObject.mesh.update();

    nameA = morphObject.availableAnimals[ 0 ];

    if (morphObject.availableAnimals.length == 1){
      document.getElementById('guidat-morph').style.display = 'none';
      nameB = morphObject.availableAnimals[0];
    } else {
      document.getElementById('guidat-morph').style.display = 'block';
      nameB = morphObject.availableAnimals[1];
    }
    rootY.addChild(morphObject.mesh);

    morphObject.play(nameA, nameB, 0, 0, 0);
    cameraDistance = 200 + morphObject.mesh.boundRadius;
  }

  centerY = models[id].centerY;
  riseY = models[id].riseY;
  gridSpeed = models[id].speed;
  params.auto = true;

}

function mouseOut(e) {
}
function mouseDown(e) {
  drag = true;
}
function mouseUp(e) {
  drag = false;
}
function mouseMove(e) {
  var currentX = (event.clientX - container.offsetLeft - width / 2) / width * 2
  var currentY = (event.clientY - container.offsetTop - height / 2) / height * 2
  var deltaX = mouseX - currentX;
  var deltaY = mouseY - currentY;
  if (drag) {
    offsetX -= deltaX;
    offsetY -= deltaY;
  }
  mouseX = currentX;
  mouseY = currentY;
}
function mouseWheel(e) {
  firstDraw = true;
  var steps = e.wheelDeltaY ? e.wheelDeltaY : -e.detail * 13;

  maxZ = 800;
  minZ = -200;

  zoom -= steps;
  if (zoom < minZ) {
    zoom = minZ;
  } else if (zoom > maxZ) {
    zoom = maxZ;
  }
}

function animate() {
  time = new Date().getTime();
  delta = time - oldTime;
  oldTime = time;
  sineTime = Math.sin( time/1000 )/2+0.5;
  if (params.auto) params.morph = sineTime;

  orbitY += (offsetX - orbitY) / 10;
  orbitZ += (offsetY - orbitZ) / 30;
  orbitZ = Math.max(-0.16,Math.min(0.16,orbitZ));

  rootY.rotation.y = orbitY * Math.PI - Math.PI/2;
  rootZ.rotation.z = orbitZ * Math.PI + Math.PI/6;

  rootY.position.y = -centerY;

  plane.position.z -= delta * params.speed * gridSpeed;
  plane.position.z = plane.position.z % 100;
  plane.position.y = -riseY;

  camera.position.x -= ( cameraDistance + zoom + camera.position.x) / 20;

  THREE.AnimationHandler.update(delta * params.speed);
  if (typeof(morphObject) != "undefined")  morphObject.morph = params.morph*2-0.5;

  if (typeof(effector) != "undefined"){
    effector.position.x = TriggerBigShader.effectors[ 0 ] = effector.start.x * (1-params.morph) + effector.end.x * params.morph;
    effector.position.y = TriggerBigShader.effectors[ 1 ] = effector.start.y * (1-params.morph) + effector.end.y * params.morph;
    effector.position.z = TriggerBigShader.effectors[ 2 ] = effector.start.z * (1-params.morph) + effector.end.z * params.morph;
  }

  faceMat.wireframe = params.wireframe;
  if (typeof(trigger) != "undefined"){
    trigger.material.wireframe = params.wireframe;
    trigger.material.vertexColors = params.texture;
  }
  if (typeof(morphObject) != "undefined"){
    morphObject.material.wireframe = params.wireframe;
  }

  renderer.render(scene, camera);

  requestAnimationFrame(animate);
}

</script>
</body>

<html> 