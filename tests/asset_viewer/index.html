<!DOCTYPE HTML>


<head>

  <title>three.js webgl - flamingo</title>
  <script type="text/javascript" src="gui-dat/gui.js"></script>
  <script type="text/javascript" src="gui-dat/controllers/slider.js"></script>
  <script type="text/javascript" src="gui-dat/controllers/controller.js"></script>
  <script type="text/javascript" src="gui-dat/controllers/controller.boolean.js"></script>
  <script type="text/javascript" src="gui-dat/controllers/controller.function.js"></script>
  <script type="text/javascript" src="gui-dat/controllers/controller.number.js"></script>
  <script type="text/javascript" src="gui-dat/controllers/controller.string.js"></script>
  <script type="text/javascript" src="js/Three.js"></script>
  <script type="text/javascript" src="js/Animal.js"></script>
  <script type="text/javascript" src="js/TriggerBig.js"></script>
  <script type="text/javascript" src="js/Detector.js"></script>
  <script type="text/javascript" src="js/RequestAnimationFrame.js"></script>
  <style type="text/css">
    @import url("style.css");
    @import url("gui-dat/gui.css");
  </style>
</head>

<body>
<div id="wrapper">
    <div id="canvasHolder"></div>
    <div id="viewerConsole">
      <div id="viewerModels">
      </div>
      <div id="viewerSettings">
      </div>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
</div>
<script>

if (! Detector.webgl) Detector.addGetWebGLMessage();

var params, gui;

var delta, time, oldTime = new Date().getTime();

var container, loader;

var camera, effector, scene, renderer;
var cameraDistance = 300;
var cameraTarget = new THREE.Vector3(0, 0, 0);

var light = [];

var rootY, rootZ, plane, mat, mesh;
var models = [];
var width = 960;
var height = 360;

var drag = false;
var mouseX = 0;
var mouseY = 0;
var offsetX = 0.5;
var offsetY = 0;
var zoom = 0;
var orbitY = 0.5;
var orbitZ = 0;
var riseY = 0;
var centerY = 0;
var gridSpeed = 1;

init();

function init() {
  container = document.createElement('div');
  container.id = "viewerCanvas";
  
  document.addEventListener('mouseup', mouseUp, false);
  document.addEventListener('mousemove', mouseMove, false);
  document.addEventListener('mousewheel', mouseWheel, false);
  document.getElementById('canvasHolder').appendChild(container);
  document.getElementById('canvasHolder').addEventListener('mousedown', mouseDown, false);
  document.getElementById('canvasHolder').addEventListener('mouseout', mouseOut, false);

  params = {"speed": 0.3, "morph": 1};
  gui = new GUI({domElement:  document.getElementById('viewerSettings')});
  gui.add(params, "speed", 0, 1);
  gui.add(params, "morph", 0, 1);

  camera = new THREE.Camera(45, width / height, 1, 4000);

  camera.position = new THREE.Vector3(-cameraDistance, 0, 0);
  camera.target.position = cameraTarget;

  renderer = new THREE.WebGLRenderer({ antialias: true, clearColor: 0x000000, clearAlpha: 0 });
  renderer.setSize(width, height);
  container.appendChild(renderer.domElement);


  light[0] = new THREE.AmbientLight( 0xffffff );
  //light[0].color.setHSV( 0.6352941176470588,  0.36470588235294116, 0.25882352941176473 );

  light[1] = new THREE.DirectionalLight( 0xffffff );
  light[1].position.set( 0.3653150890069558,  0.7392613273917799, -0.5657186363969139 );
  light[1].color.setHSV( 0.07647058823529412, 0.058823529411764705,  0.7235294117647059 );
  light[1].castShadow = true;

  light[2] = new THREE.DirectionalLight( 0xffffff );
  light[2].position.set( -0.8304706750947658,  -0.47758995481714017,  0.2867512735201115 );
  light[2].color.setHSV( 0,  0, 0.5058823529411764 );
  light[2].castShadow = false;

  //gound plane
  mat = new THREE.MeshBasicMaterial({blending: THREE.BillboardBlending, color:0xb65024, opacity:0.1, wireframe: true });
  plane = new THREE.Mesh(new THREE.Plane(1000, 1000, 10, 10), mat);
  plane.rotation.x = -Math.PI / 2;

  //Triggers
  models.push({"file": './triggerModels/city/Bottom_Console_4_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Bottom_Console_7_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Bottom_Console_12_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Bottom_Console_13_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Car_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/CarNiss_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/CarPile_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Console_10_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Console_11_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Console_14_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Console_15_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Console_2_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Console_3_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Console_5_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Console_6_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/Console_8_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/LampPost_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/RailTrain_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/SignBroken_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/city/SignMany_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Car1_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Car2_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Car4_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/cargo1morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/cargo2morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Hayball_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/House1_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/House2_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/House3_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Powerline_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Silo_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Tractor_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Trainmorph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Tree1_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Tree2_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Treegroup_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Truck_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Watertower_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  models.push({"file": './triggerModels/country/Windmill_morph.js', "type": 'trigger', "centerY": 60, "riseY" : 0, "speed": 0});
  
  //MORPHS
  models.push({"file": './morphModels/raven_eagle.js', "type": 'animal', "centerY": 0, "riseY" : 70, "speed": 0.9});
  models.push({"file": './morphModels/vulture_hummingbird.js', "type": 'animal', "centerY": 0, "riseY" : 70, "speed": 0.9});
  models.push({"file": './morphModels/owl_parrot.js', "type": 'animal', "centerY": 0, "riseY" : 70, "speed": 0.8});
  models.push({"file": './morphModels/stork_flamingo.js', "type": 'animal', "centerY": 0, "riseY" : 60, "speed": 0.8});
  models.push({"file": './morphModels/black_widow_scorpion.js', "type": 'animal', "centerY": 30, "riseY" : 0, "speed": 0.47});
  models.push({"file": './morphModels/wolf_fox.js', "type": 'animal', "centerY": 30, "riseY" : 0, "speed": 0.47});
  models.push({"file": './morphModels/fish1_fish2.js', "type": 'animal', "centerY": 100, "riseY" : -160, "speed": 0.2});
  models.push({"file": './morphModels/toad_treeFrog.js', "type": 'animal', "centerY": 30, "riseY" : 0, "speed": 0.47});
  models.push({"file": './morphModels/chowchow_retreiver.js', "type": 'animal', "centerY": 50, "riseY" : 0, "speed": 0.35});
  models.push({"file": './morphModels/sealRun_bearBrown.js', "type": 'animal', "centerY": 60, "riseY" : 0, "speed": 0.35});
  models.push({"file": './morphModels/horse_bear.js', "type": 'animal', "centerY": 90, "riseY" : 0, "speed": 0.47});
  models.push({"file": './morphModels/tarbuffaloA_tarbuffaloB.js', "type": 'animal', "centerY": 90, "riseY" : 0, "speed": 0.47});

  //BLACK SOUP
  models.push({"file": './newModels/gator.js', "type": 'animal', "centerY": 40, "riseY" : 0, "speed": 0.4});
  models.push({"file": './newModels/centipede.js', "type": 'animal', "centerY": 20, "riseY" : 0, "speed": 0.5});
  models.push({"file": './newModels/goat.js', "type": 'animal', "centerY": 50, "riseY" : 0, "speed": 0.5});
  models.push({"file": './newModels/crab.js', "type": 'animal', "centerY": 40, "riseY" : 0, "speed": 0.2});
  models.push({"file": './newModels/cow.js', "type": 'animal', "centerY": 80, "riseY" : 0, "speed": 0});

  //LIFE SOUP
  models.push({"file": './newModels/eagle.js', "type": 'animal', "centerY": 0, "riseY" : 80, "speed": 0.8});
  models.push({"file": './newModels/elk.js', "type": 'animal', "centerY": 70, "riseY" : 0, "speed": 0.4});
  models.push({"file": './newModels/moose.js', "type": 'animal', "centerY": 140, "riseY" : 0, "speed": 0.8});

  modelLoader(0);

}

function modelLoader(id) {
    loader = new THREE.JSONLoader();
    loader.load({ model: models[id].file, callback: function(g) {
    addModel(g, id);
  } });
}

function addModel(geometry, id) {
  models[id].geometry = geometry;

  link = document.createElement('a');
  link.setAttribute('class', 'modelLink');
  link.setAttribute('href', 'javascript:switchModel('+id+')');

  models[id].name = models[id].file.replace(/\\/g,'/').replace( /.*\//, '' );
  models[id].name = models[id].name.replace(".js", "");
  link.innerHTML = models[id].name.replace("_", "<br />");

  document.getElementById('viewerModels').appendChild(link);

  if (id == 0){
    switchModel(0);
    animate();
  }
  if (id < models.length-1) {
    modelLoader(id+1);
  }
}

var morphObject;

function switchModel(id) {

  scene = new THREE.Scene();
  rootY = new THREE.Object3D();
  rootZ = new THREE.Object3D();
  scene.addObject(rootZ);
  rootZ.addChild(rootY);

  rootY.addChild(light[0]);
  rootY.addChild(light[1]);
  rootY.addChild(light[2]);
  rootY.addChild(plane);

  if (models[id].type == "trigger"){

    trigger = new TriggerBig( models[id].geometry, undefined );
    trigger.doubleSided = true;

    var baseLoader = new THREE.JSONLoader();
    baseLoader.load( { model: models[id].file.replace("morph", ""), callback: function( geometry ) {
      var mesh = new THREE.Mesh( geometry, new THREE.MeshFaceMaterial());
      if (models[id].file.search("city") != -1) mesh.scale.set(0.1,0.1,0.1);
      if (models[id].file.search("country") != -1) mesh.scale.set(10,10,10);
      //mesh.rotation.x = -90 * Math.PI / 180;
      mesh.addChild( trigger.mesh );
      //trigger.mesh.rotation.x = 90 * Math.PI / 180;
      trigger.mesh.scale.set( 1, 1, 1 );

      rootY.addChild( mesh );

      effector = new THREE.Mesh( new THREE.Sphere( 1500, 3, 3 ), new THREE.MeshLambertMaterial( { color: 0xff0000, wireframe: true }));
      //rootY.addChild( effector );
    }});

    effector = new THREE.Mesh( new THREE.Sphere( 1500, 3, 3 ), new THREE.MeshLambertMaterial( { color: 0xff0000, wireframe: true }));

  }

  if (models[id].type == "animal"){
    morphObject = new ROME.Animal(models[id].geometry, true);
    morphObject.mesh.updateMatrix();
    morphObject.mesh.update();

    nameA = morphObject.availableAnimals[ 0 ];
    nameB = morphObject.availableAnimals[ (morphObject.availableAnimals.length > 1) ? 1 : 0 ];

    rootY.addChild(morphObject.mesh);

    morphObject.play(nameA, nameB, 0, 0, 0);
    cameraDistance = 200 + morphObject.mesh.boundRadius;
  }

  centerY = models[id].centerY;
  riseY = models[id].riseY;
  gridSpeed = models[id].speed;

}

function mouseOut(e) {
}
function mouseDown(e) {
  drag = true;
}
function mouseUp(e) {
  drag = false;
}
function mouseMove(e) {
  var currentX = (event.clientX - container.offsetLeft - width / 2) / width * 2
  var currentY = (event.clientY - container.offsetTop - height / 2) / height * 2
  var deltaX = mouseX - currentX;
  var deltaY = mouseY - currentY;
  if (drag) {
    offsetX -= deltaX;
    offsetY -= deltaY;
  }
  mouseX = currentX;
  mouseY = currentY;
}
function mouseWheel(e) {
  firstDraw = true;
  var steps = e.wheelDeltaY ? e.wheelDeltaY : -e.detail * 13;

  maxZ = 800;
  minZ = -200;

  zoom -= steps;
  if (zoom < minZ) {
    zoom = minZ;
  } else if (zoom > maxZ) {
    zoom = maxZ;
  }
}

function animate() {
  time = new Date().getTime();
  delta = time - oldTime;
  oldTime = time;

  orbitY += (offsetX - orbitY) / 10;
  orbitZ += (offsetY - orbitZ) / 30;
  orbitZ = Math.max(-0.16,Math.min(0.16,orbitZ));

  rootY.rotation.y = orbitY * Math.PI - Math.PI/2;
  rootZ.rotation.z = orbitZ * Math.PI + Math.PI/6;

  rootY.position.y = -centerY;

  plane.position.z -= delta * params.speed * gridSpeed;
  plane.position.z = plane.position.z % 100;
  plane.position.y = -riseY;

  camera.position.x -= ( cameraDistance + zoom + camera.position.x) / 20;

  THREE.AnimationHandler.update(delta * params.speed);
  if (typeof(morphObject) != "undefined")  morphObject.morph = params.morph*2-0.5;

  if (typeof(effector) != "undefined"){
    effector.position.x = TriggerBigShader.effectors[ 0 ] = Math.sin( time/1000 )*3000;
    effector.position.y = TriggerBigShader.effectors[ 1 ];
    effector.position.z = TriggerBigShader.effectors[ 2 ] = 1500;//TriggerBigShader.effectors[ 2 ] = Math.cos( t ) * 1000 + 1000;
  }

  renderer.render(scene, camera);

  requestAnimationFrame(animate);
}

</script>
</body>

<html> 